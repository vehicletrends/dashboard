---
title: "Market Concentration"
---

```{r}
#| label: setup
#| include: false

source("setup.R")

data <- vehicletrends::hhi_local |>
  filter(!(group_var == "price_bin" & group_level == "Other")) |>
  mutate(lower = pmax(lower, 0))

hhi_labels <- c(
  "make" = "Make",
  "vehicle_type" = "Vehicle Type",
  "price_bin" = "Price Bin"
)

make_boxplot <- function(data, gv, hv) {
  plot_data <- data |>
    filter(group_var == gv, hhi_var == hv)

  years <- sort(unique(plot_data$listing_year))
  levels <- sort(unique(plot_data$group_level))

  # Chart height based on number of categories
  chart_height <- paste0(max(300, length(levels) * 50 + 120), "px")

  # Left margin based on longest label
  grid_left <- max(100, max(nchar(levels)) * 7.5 + 30)

  # Build timeline options (one per year)
  opts <- lapply(years, function(yr) {
    yr_data <- plot_data |> filter(listing_year == yr)

    box_data <- lapply(levels, function(lvl) {
      row <- yr_data |> filter(group_level == lvl)
      if (nrow(row) == 0) {
        return(list(0, 0, 0, 0, 0))
      }
      c(row$lower[1], row$q25[1], row$median[1], row$q75[1], row$upper[1])
    })

    list(series = list(list(data = box_data)))
  })

  echarts4r::e_charts(height = chart_height) |>
    echarts4r::e_list(list(
      baseOption = list(
        timeline = list(
          data = as.character(years),
          autoPlay = FALSE,
          bottom = 0,
          playInterval = 1500
        ),
        tooltip = list(trigger = "item"),
        grid = list(left = grid_left, bottom = 80),
        yAxis = list(
          type = "category",
          data = levels,
          inverse = TRUE
        ),
        xAxis = list(
          type = "value",
          name = "HHI",
          min = 0
        ),
        series = list(
          list(type = "boxplot")
        ),
        toolbox = list(
          feature = list(saveAsImage = list())
        )
      ),
      options = opts
    ))
}
```

We use the [Herfindahlâ€“Hirschman Index (HHI)](https://en.wikipedia.org/wiki/Herfindahl%E2%80%93Hirschman_Index) to measure how concentrated or competitive each market segment is over time. The HHI ranges from 0 to 1, with the following general guidelines: 

- <0.10: Very competitive market
- 0.10 - 0.15: Competitive market
- 0.15 - 0.25: Moderate concentration
- 0.25 - 0.5: Concentrated market 
- \>0.5: Very concentrated market 

See the [HHI Explained](hhi-explained.qmd) page for an interactive tool that illustrates how HHI relates to market share distributions.

Concentration is measured across three groups: **Powertrain**, **Vehicle Type** (Body Style), and **Price Bin**. Within each group, you can choose a level and HHI dimension to view: **make**, **vehicle type** (body style), and **price bin**. The map below allows you to select any of these dimensions for any listing year for every U.S. census tract.

Below the map are boxplots that summarize the distribution of HHI values across all census tracts for a given year. Use the timeline slider below each chart to switch between years. 

## Map

<center>
<a href="https://vehicletrends.github.io/hhi-map/" target="_blank" style="display: inline-block; padding: 8px 16px; background-color: #0066cc; color: white; text-decoration: none; border-radius: 4px; margin-bottom: 10px;">View map in new tab</a>
</center>

```{r}
htmltools::tags$iframe(
  src = "https://vehicletrends.github.io/hhi-map/",
  height = "700px",
  width = "100%",
  style = "border: none;"
)
```

## By Powertrain

### HHI by Make
```{r}
make_boxplot(data, "powertrain", "make")
```

### HHI by Vehicle Type
```{r}
make_boxplot(data, "powertrain", "vehicle_type")
```

### HHI by Price Bin
```{r}
make_boxplot(data, "powertrain", "price_bin")
```

## By Vehicle Type

### HHI by Make
```{r}
make_boxplot(data, "vehicle_type", "make")
```

### HHI by Price Bin
```{r}
make_boxplot(data, "vehicle_type", "price_bin")
```

## By Price Bin

### HHI by Make
```{r}
make_boxplot(data, "price_bin", "make")
```

### HHI by Vehicle Type
```{r}
make_boxplot(data, "price_bin", "vehicle_type")
```

## Data

<center>
<a href="`r url_hhi`" style="display: inline-block; padding: 8px 16px; background-color: #0066cc; color: white; text-decoration: none; border-radius: 4px; margin-bottom: 10px;">Download data</a>

<div style="width:900px">

```{r}
data |>
  mutate(
    mean = round(mean, 3),
    median = round(median, 3),
    q25 = round(q25, 3),
    q75 = round(q75, 3),
    IQR = round(IQR, 3),
    upper = round(upper, 3),
    lower = round(lower, 3)
  ) |>
  rename(
    `Group Variable` = group_var,
    `Group Level` = group_level,
    `HHI Variable` = hhi_var,
    Year = listing_year,
    Mean = mean,
    Median = median,
    Q25 = q25,
    Q75 = q75,
    Upper = upper,
    Lower = lower
  ) |>
  reactable::reactable(
    searchable = TRUE,
    highlight = TRUE,
    filterable = TRUE,
    defaultPageSize = 10,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 10, 25, 50),
    defaultColDef = reactable::colDef(
      minWidth = 70
    )
  )
```

</div>
</center>
