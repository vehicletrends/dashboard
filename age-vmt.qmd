---
title: "Vehicle Miles Traveled (VMT) by Age"
---

```{r}
#| include: false

library(dplyr)
library(echarts4r)

# Load data and convert age from months to years
data_url <- "https://raw.githubusercontent.com/vehicletrends/vehicletrends/refs/heads/main/data-raw/vmt_age.csv"
data <- read.csv(data_url) |>
  mutate(age_years = age_bin / 12)

# Helper function to apply loess smoothing to a group
smooth_group <- function(df, x_col, y_col, span = 0.5) {
  if (nrow(df) < 10) {
    df$miles_smooth <- df[[y_col]]
    return(df)
  }
  tryCatch({
    fit <- suppressWarnings(loess(df[[y_col]] ~ df[[x_col]], span = span))
    df$miles_smooth <- predict(fit)
    df
  }, error = function(e) {
    df$miles_smooth <- df[[y_col]]
    df
  })
}

# Apply smoothing to all data
data <- data |>
  group_by(powertrain, vehicle_type, quantile) |>
  group_modify(~ smooth_group(.x, "age_years", "miles")) |>
  ungroup()

# Filter to 50th quantile for charts
chart_data <- data |>
  filter(quantile == 50)

# Helper function to create a chart for a given facet
make_chart <- function(data, facet_var, facet_value, line_var) {
  plot_data <- data |>
    filter(.data[[facet_var]] == facet_value)

  plot_data |>
    group_by(.data[[line_var]]) |>
    e_charts(age_years) |>
    e_line(miles_smooth, symbol = "none", smooth = FALSE) |>
    e_tooltip(
      trigger = "axis",
      formatter = htmlwidgets::JS("
        function(params) {
          var result = params[0].axisValueLabel + '<br/>';
          params.forEach(function(item) {
            result += item.marker + ' ' + item.seriesName + ': ' +
                      Math.round(item.value[1]).toLocaleString() + '<br/>';
          });
          return result;
        }
      ")
    ) |>
    e_x_axis(name = "Age (years)") |>
    e_y_axis(name = "Miles") |>
    e_legend(
      show = TRUE,
      orient = "horizontal",
      left = "center",
      bottom = 0,
      width = "70%",
      selector = list(
        list(type = "all", title = "All"),
        list(type = "inverse", title = "Inverse")
      ),
      selectorPosition = "start"
    ) |>
    e_grid(bottom = 100) |>
    e_color(background = "transparent") |>
    e_toolbox_feature(feature = "dataZoom") |>
    e_toolbox_feature(feature = "saveAsImage")
}
```

This page shows median cumulative vehicle miles traveled (VMT) by vehicle age. Each chart displays the 50th quantile (median) of total mileage for a given combination of powertrain and vehicle type as vehicles age over time. The "Data" tab shows the raw data, which also includes the 25th and 75th quantiles. Lines that are less smooth are the result of less data for that particular combination of powertrain and vehicle type. See the [about](about.html#vehicle-miles-traveled-vmt) page for more details.

::: {.panel-tabset}

## By Vehicle Type

*Click legend items to show/hide lines.*

::: {.grid}

::: {.g-col-6}
#### Car
```{r}
make_chart(chart_data, "vehicle_type", "Car", "powertrain")
```
:::

::: {.g-col-6}
#### SUV
```{r}
make_chart(chart_data, "vehicle_type", "SUV", "powertrain")
```
:::

::: {.g-col-6}
#### CUV
```{r}
make_chart(chart_data, "vehicle_type", "CUV", "powertrain")
```
:::

::: {.g-col-6}
#### Pickup
```{r}
make_chart(chart_data, "vehicle_type", "Pickup", "powertrain")
```
:::

::: {.g-col-6}
#### Minivan
```{r}
make_chart(chart_data, "vehicle_type", "Minivan", "powertrain")
```
:::

:::

## By Powertrain

*Click legend items to show/hide lines.*

::: {.grid}

::: {.g-col-6}
#### BEV
```{r}
make_chart(chart_data, "powertrain", "BEV", "vehicle_type")
```
:::

::: {.g-col-6}
#### BEV (Tesla)
```{r}
make_chart(chart_data, "powertrain", "BEV (Tesla)", "vehicle_type")
```
:::

::: {.g-col-6}
#### BEV (Non-Tesla)
```{r}
make_chart(chart_data, "powertrain", "BEV (Non-Tesla)", "vehicle_type")
```
:::

::: {.g-col-6}
#### Conventional
```{r}
make_chart(chart_data, "powertrain", "Conventional", "vehicle_type")
```
:::

::: {.g-col-6}
#### Diesel
```{r}
make_chart(chart_data, "powertrain", "Diesel", "vehicle_type")
```
:::

::: {.g-col-6}
#### Flex Fuel
```{r}
make_chart(chart_data, "powertrain", "Flex Fuel", "vehicle_type")
```
:::

::: {.g-col-6}
#### Fuel Cell EV
```{r}
make_chart(chart_data, "powertrain", "Fuel Cell EV", "vehicle_type")
```
:::

::: {.g-col-6}
#### Hybrid
```{r}
make_chart(chart_data, "powertrain", "Hybrid", "vehicle_type")
```
:::

::: {.g-col-6}
#### PHEV
```{r}
make_chart(chart_data, "powertrain", "PHEV", "vehicle_type")
```
:::

:::

## Data

<center>
[Download data](https://raw.githubusercontent.com/vehicletrends/vehicletrends/refs/heads/main/data-raw/vmt_age.csv)

<div style="width:900px">

```{r}
data |>
  mutate(
    age_years = round(age_years, 2),
    miles = round(miles, 0),
    miles_smooth = round(miles_smooth, 0)
  ) |>
  select(powertrain, vehicle_type, age_years, quantile, miles, miles_smooth) |>
  rename(
    Powertrain = powertrain,
    `Vehicle Type` = vehicle_type,
    `Age (years)` = age_years,
    Quantile = quantile,
    Miles = miles,
    `Miles (Smoothed)` = miles_smooth
  ) |>
  reactable::reactable(
    searchable = TRUE,
    highlight = TRUE,
    filterable = TRUE,
    defaultPageSize = 10,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 10, 25, 50)
  )
```

</div>
</center>

:::
