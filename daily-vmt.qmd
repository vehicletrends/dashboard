---
title: "Daily VMT"
format:
  html:
    include-in-header:
      text: |
        <style>
        .shinylive-wrapper,
        .shinylive-container {
          box-shadow: none !important;
          border: none !important;
        }
        </style>
filters:
  - shinylive
warning: false
---

::: {.panel-tabset}

## Charts

```{shinylive-r}
#| standalone: true
#| viewerHeight: 800

library(shiny)
library(dplyr)
library(bslib)
library(echarts4r)

data_url <- "https://raw.githubusercontent.com/vehicletrends/data/refs/heads/main/data/quantiles_dvmt.csv"
data <- read.csv(data_url)

ui <- page_sidebar(
  title = "DVMT Quantiles by Vehicle Type",
  sidebar = sidebar(
    radioButtons(
      "facet_by",
      "Facet by:",
      choices = c("Powertrain" = "powertrain", "Vehicle Type" = "vehicle_type"),
      selected = "powertrain"
    ),
    checkboxGroupInput(
      "vehicle_types",
      "Vehicle Types:",
      choices = unique(data$vehicle_type),
      selected = unique(data$vehicle_type)
    ),
    checkboxGroupInput(
      "powertrains",
      "Powertrains:",
      choices = unique(data$powertrain),
      selected = unique(data$powertrain)
    )
  ),
  uiOutput("charts")
)

server <- function(input, output, session) {
  filtered_data <- reactive({
    data %>%
      filter(
        vehicle_type %in% input$vehicle_types,
        powertrain %in% input$powertrains
      )
  })

  output$charts <- renderUI({
    req(nrow(filtered_data()) > 0)

    # Determine which variable to facet by
    if (input$facet_by == "powertrain") {
      facet_values <- sort(unique(filtered_data()$powertrain))
    } else {
      facet_values <- sort(unique(filtered_data()$vehicle_type))
    }

    chart_outputs <- lapply(facet_values, function(fv) {
      output_id <- paste0("chart_", gsub("[^A-Za-z0-9]", "_", fv))

      card(
        card_header(fv),
        echarts4rOutput(output_id, height = "300px")
      )
    })

    layout_column_wrap(
      width = 1 / 2,
      !!!chart_outputs
    )
  })

  observe({
    req(nrow(filtered_data()) > 0)

    # Determine which variable to facet by and which to use for lines
    if (input$facet_by == "powertrain") {
      facet_values <- sort(unique(filtered_data()$powertrain))
      facet_var <- "powertrain"
      line_var <- "vehicle_type"
    } else {
      facet_values <- sort(unique(filtered_data()$vehicle_type))
      facet_var <- "vehicle_type"
      line_var <- "powertrain"
    }

    lapply(facet_values, function(fv) {
      output_id <- paste0("chart_", gsub("[^A-Za-z0-9]", "_", fv))

      local({
        fv_local <- fv
        output[[output_id]] <- renderEcharts4r({
          chart_data <- filtered_data() %>%
            filter(.data[[facet_var]] == fv_local)

          chart_data %>%
            group_by(.data[[line_var]]) %>%
            e_charts(dvmt) %>%
            e_line(quantile, symbol = "none", smooth = FALSE) %>%
            e_tooltip(trigger = "axis") %>%
            e_x_axis(name = "DVMT") %>%
            e_y_axis(name = "Quantile") %>%
            e_legend(
              show = TRUE,
              orient = "horizontal",
              left = "center",
              bottom = 0
            ) %>%
            e_grid(bottom = 80) %>%
            e_color(background = "transparent") %>%
            e_toolbox_feature(feature = "saveAsImage")
        })
      })
    })
  })
}

shinyApp(ui, server)
```

## Data

<center>
[Download data](https://cdn.jsdelivr.net/gh/vehicletrends/data@main/data/quantiles_dvmt.csv)

<div style="width:700px">

```{r}
library(dplyr)

data_url <- "https://raw.githubusercontent.com/vehicletrends/data/refs/heads/main/data/quantiles_dvmt.csv"
data <- read.csv(data_url)

data |>
  mutate(
    powertrain = case_when(
      powertrain == "all" ~ "All",
      powertrain == "bev" ~ "BEV",
      powertrain == "bev_non_tesla" ~ "BEV (non-Tesla)",
      powertrain == "bev_tesla" ~ "BEV (Tesla)",
      powertrain == "phev" ~ "PHEV",
      powertrain == "hev" ~ "HEV",
      powertrain == "cv" ~ "Conventional Vehicle",
      TRUE ~ powertrain
    )
  ) |>
  mutate(
    dvmt = round(dvmt, 2)
  ) |>
  rename(
    Powertrain = powertrain,
    `Vehicle Type` = vehicle_type,
    Quantile = quantile,
    DVMT = dvmt
  ) |>
  reactable::reactable(
    searchable = TRUE,
    highlight = TRUE,
    filterable = TRUE,
    defaultPageSize = 10,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 10, 25, 50)
  )
```

</div>
</center>

:::
