---
title: "Percent of Listings"
---

This page shows how the composition of vehicle listings has changed over time across different market dimensions. The analysis breaks down listings by three key variables:

- **Powertrain**: Gasoline, Diesel, Hybrid Electric (HEV), Plug-in Hybrid Electric (PHEV), and Battery Electric (BEV)
- **Vehicle Type**: Car, Crossover (CUV), Sport Utility Vehicle (SUV), Pickup, and Minivan
- **Price Bin**: Price ranges grouping vehicles into different market segments

All charts separate new and used vehicle markets, showing trends from 2018-2025. The "Summary Over Time" section highlights changes between 2018 and 2025, while the "Overall Trends" section displays year-by-year changes. The remaining sections show how these variables interact with each other (e.g., how powertrain distribution varies across different vehicle types).

```{r}
#| include: false

source("setup.R")

data <- percent_listings |>
  mutate(percent = round(p * 100, 2))

# Nice labels for group/category variables
var_labels <- c(
  powertrain = "Powertrain",
  vehicle_type = "Vehicle Type",
  price_bin = "Price Bin"
)

# Get unique group × category combinations
combos <- data |>
  distinct(group_var, category_var)

# Helper function to create a chart for a given group_level
make_chart <- function(data, grp_var, grp_level, cat_var, inv_type) {
  plot_data <- data |>
    filter(
      group_var == grp_var,
      group_level == grp_level,
      category_var == cat_var,
      inventory_type == inv_type
    )

  if (nrow(plot_data) == 0) {
    return(NULL)
  }

  plot_data |>
    mutate(listing_year = as.character(listing_year)) |>
    arrange(listing_year) |>
    group_by(category_level) |>
    e_charts(listing_year) |>
    e_line(
      percent,
      symbol = "circle",
      symbolSize = 8,
      emphasis = list(focus = "series")
    ) |>
    e_tooltip(
      trigger = "item",
      formatter = htmlwidgets::JS(
        "
        function(params) {
          return params.seriesName + '<br/>' +
                 'Year: ' + params.name + '<br/>' +
                 'Percent: ' + params.value[1].toFixed(2) + '%';
        }
      "
      )
    ) |>
    e_x_axis(
      name = "Listing Year",
      type = "category"
    ) |>
    e_y_axis(name = "% of Listings") |>
    e_legend(
      show = TRUE,
      orient = "horizontal",
      left = "center",
      bottom = 0,
      width = "70%",
      selectedMode = "multiple",
      selector = list(
        list(type = "all", title = "All"),
        list(type = "inverse", title = "Inverse")
      ),
      selectorPosition = "start"
    ) |>
    e_grid(bottom = 100) |>
    e_color(background = "transparent") |>
    e_toolbox_feature(feature = "dataZoom") |>
    e_toolbox_feature(feature = "saveAsImage")
}

# Helper to render a grid of charts for a group×category combo
render_combo <- function(data, grp_var, cat_var, inv_type) {
  levels <- data |>
    filter(
      group_var == grp_var,
      category_var == cat_var,
      inventory_type == inv_type
    ) |>
    distinct(group_level) |>
    pull(group_level) |>
    sort()

  charts <- lapply(levels, function(lvl) {
    chart <- make_chart(data, grp_var, lvl, cat_var, inv_type)
    if (is.null(chart)) {
      return(NULL)
    }
    htmltools::div(
      class = "g-col-6",
      htmltools::h4(lvl),
      chart
    )
  })

  # Remove NULLs
  charts <- Filter(Negate(is.null), charts)

  htmltools::div(class = "grid", charts)
}

# Helper to create a single overall time series chart
make_overall_chart <- function(data, var_name, inv_type) {
  cat_var <- setdiff(c("powertrain", "vehicle_type", "price_bin"), var_name)[1]

  plot_data <- data |>
    filter(
      group_var == var_name,
      category_var == cat_var,
      inventory_type == inv_type
    ) |>
    group_by(listing_year, group_level) |>
    summarise(total_n = sum(n), .groups = "drop") |>
    group_by(listing_year) |>
    mutate(percent = round(total_n / sum(total_n) * 100, 2)) |>
    ungroup()

  plot_data |>
    mutate(listing_year = as.character(listing_year)) |>
    arrange(listing_year) |>
    group_by(group_level) |>
    e_charts(listing_year, height = "500px") |>
    e_line(
      percent,
      symbol = "circle",
      symbolSize = 8,
      emphasis = list(focus = "series")
    ) |>
    e_tooltip(
      trigger = "item",
      formatter = htmlwidgets::JS(
        "
        function(params) {
          return params.seriesName + '<br/>' +
                 'Year: ' + params.name + '<br/>' +
                 'Percent: ' + params.value[1].toFixed(2) + '%';
        }
      "
      )
    ) |>
    e_x_axis(
      name = "Listing Year",
      type = "category"
    ) |>
    e_y_axis(name = "% of Listings") |>
    e_legend(
      show = TRUE,
      orient = "horizontal",
      left = "center",
      bottom = 0,
      width = "70%",
      selectedMode = "multiple",
      selector = list(
        list(type = "all", title = "All"),
        list(type = "inverse", title = "Inverse")
      ),
      selectorPosition = "start"
    ) |>
    e_grid(bottom = 100) |>
    e_color(background = "transparent") |>
    e_toolbox_feature(feature = "dataZoom") |>
    e_toolbox_feature(feature = "saveAsImage")
}

# Helper to compute overall shares and create horizontal dumbbell chart
make_summary_dumbbell <- function(data, var_name, inv_type) {
  cat_var <- setdiff(c("powertrain", "vehicle_type", "price_bin"), var_name)[1]

  db <- data |>
    filter(
      group_var == var_name,
      category_var == cat_var,
      inventory_type == inv_type,
      listing_year %in% c(2018, 2025)
    ) |>
    group_by(listing_year, group_level) |>
    summarise(total_n = sum(n), .groups = "drop") |>
    group_by(listing_year) |>
    mutate(pct = round(total_n / sum(total_n) * 100, 2)) |>
    ungroup() |>
    select(listing_year, group_level, pct) |>
    tidyr::pivot_wider(
      names_from = listing_year,
      values_from = pct,
      names_prefix = "y"
    ) |>
    mutate(
      y2018 = ifelse(is.na(y2018), 0, y2018),
      y2025 = ifelse(is.na(y2025), 0, y2025),
      bar_base = pmin(y2018, y2025),
      bar_height = abs(y2025 - y2018)
    )

  db |>
    e_charts(group_level, height = "350px") |>
    e_bar(
      bar_base,
      stack = "conn",
      name = "\u200b",
      barWidth = 3,
      itemStyle = list(color = "transparent"),
      emphasis = list(disabled = TRUE)
    ) |>
    e_bar(
      bar_height,
      stack = "conn",
      name = "\u200b\u200b",
      barWidth = 3,
      itemStyle = list(color = "#999"),
      emphasis = list(disabled = TRUE)
    ) |>
    e_scatter(
      y2018,
      name = "2018",
      symbol_size = 12,
      symbol = "circle",
      itemStyle = list(color = "#999")
    ) |>
    e_scatter(
      y2025,
      name = "2025",
      symbol = "diamond",
      symbol_size = 14,
      itemStyle = list(color = "#ee6666")
    ) |>
    e_flip_coords() |>
    e_y_axis(axisLabel = list(fontSize = 11)) |>
    e_x_axis(
      name = "% of Listings",
      axisLabel = list(formatter = "{value}%")
    ) |>
    e_tooltip(
      trigger = "axis",
      formatter = htmlwidgets::JS(
        "
        function(params) {
          var result = params[0].name + '<br/>';
          params.forEach(function(item) {
            if (item.seriesName === '2018' || item.seriesName === '2025') {
              var val = parseFloat(item.value[0]);
              if (!isNaN(val)) {
                result += item.marker + ' ' + item.seriesName +
                  ': ' + val.toFixed(2) + '%<br/>';
              }
            }
          });
          return result;
        }
      "
      )
    ) |>
    e_legend(
      show = TRUE,
      bottom = 0,
      left = "center",
      data = list("2018", "2025")
    ) |>
    e_grid(bottom = 60, left = 200, right = 40, top = 10) |>
    e_color(background = "transparent") |>
    e_toolbox_feature(feature = "dataZoom") |>
    e_toolbox_feature(feature = "saveAsImage")
}
```

## Overall Trends

*Click legend items to show/hide lines.*

### By Powertrain

::: {.grid}

::: {.g-col-6}

#### New Market

```{r}
make_overall_chart(data, "powertrain", "New")
```

:::

::: {.g-col-6}

#### Used Market

```{r}
make_overall_chart(data, "powertrain", "Used")
```

:::

:::

### By Vehicle Type

::: {.grid}

::: {.g-col-6}

#### New Market

```{r}
make_overall_chart(data, "vehicle_type", "New")
```

:::

::: {.g-col-6}

#### Used Market

```{r}
make_overall_chart(data, "vehicle_type", "Used")
```

:::

:::

### By Price Bin

::: {.grid}

::: {.g-col-6}

#### New Market

```{r}
make_overall_chart(data, "price_bin", "New")
```

:::

::: {.g-col-6}

#### Used Market

```{r}
make_overall_chart(data, "price_bin", "Used")
```

:::

:::

## Summary Over Time

*Hollow circles show 2018 values. Filled dots show 2025 values. Lines connect the two, showing the direction and magnitude of change.*

### By Powertrain

::: {.grid}

::: {.g-col-6}

#### New Market

```{r}
make_summary_dumbbell(data, "powertrain", "New")
```

:::

::: {.g-col-6}

#### Used Market

```{r}
make_summary_dumbbell(data, "powertrain", "Used")
```

:::

:::

### By Vehicle Type

::: {.grid}

::: {.g-col-6}

#### New Market

```{r}
make_summary_dumbbell(data, "vehicle_type", "New")
```

:::

::: {.g-col-6}

#### Used Market

```{r}
make_summary_dumbbell(data, "vehicle_type", "Used")
```

:::

:::

### By Price Bin

::: {.grid}

::: {.g-col-6}

#### New Market

```{r}
make_summary_dumbbell(data, "price_bin", "New")
```

:::

::: {.g-col-6}

#### Used Market

```{r}
make_summary_dumbbell(data, "price_bin", "Used")
```

:::

:::

## Powertrain by Vehicle Type

*Click legend items to show/hide lines.*

::: {.panel-tabset}

### New

```{r}
render_combo(data, "powertrain", "vehicle_type", "New")
```

### Used

```{r}
render_combo(data, "powertrain", "vehicle_type", "Used")
```

:::

## Powertrain by Price Bin

*Click legend items to show/hide lines.*

::: {.panel-tabset}

### New

```{r}
render_combo(data, "powertrain", "price_bin", "New")
```

### Used

```{r}
render_combo(data, "powertrain", "price_bin", "Used")
```

:::

## Vehicle Type by Powertrain

*Click legend items to show/hide lines.*

::: {.panel-tabset}

### New

```{r}
render_combo(data, "vehicle_type", "powertrain", "New")
```

### Used

```{r}
render_combo(data, "vehicle_type", "powertrain", "Used")
```

:::

## Vehicle Type by Price Bin

*Click legend items to show/hide lines.*

::: {.panel-tabset}

### New

```{r}
render_combo(data, "vehicle_type", "price_bin", "New")
```

### Used

```{r}
render_combo(data, "vehicle_type", "price_bin", "Used")
```

:::

## Price Bin by Powertrain

*Click legend items to show/hide lines.*

::: {.panel-tabset}

### New

```{r}
render_combo(data, "price_bin", "powertrain", "New")
```

### Used

```{r}
render_combo(data, "price_bin", "powertrain", "Used")
```

:::

## Price Bin by Vehicle Type

*Click legend items to show/hide lines.*

::: {.panel-tabset}

### New

```{r}
render_combo(data, "price_bin", "vehicle_type", "New")
```

### Used

```{r}
render_combo(data, "price_bin", "vehicle_type", "Used")
```

:::

## Data

<center>
<a href="`r url_percent_listings`" style="display: inline-block; padding: 8px 16px; background-color: #0066cc; color: white; text-decoration: none; border-radius: 4px; margin-bottom: 10px;">Download data</a>

<div style="width:900px">

```{r}
percent_listings |>
  mutate(
    p = round(p, 4)
  ) |>
  rename(
    `Inventory Type` = inventory_type,
    `Group Variable` = group_var,
    `Group Level` = group_level,
    `Category Variable` = category_var,
    `Category Level` = category_level,
    `Listing Year` = listing_year,
    `Count` = n,
    `Percent` = p
  ) |>
  reactable::reactable(
    searchable = TRUE,
    highlight = TRUE,
    filterable = TRUE,
    defaultPageSize = 10,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 10, 25, 50)
  )
```

</div>
</center>
