---
title: "Depreciation"
---

This page shows median vehicle depreciation (retention rate) by vehicle age. A retention rate of 1.0 means the vehicle retains 100% of its original value, while 0.5 means it has lost half its value. Each chart displays the 50th quantile (median) retention rate for a given combination of powertrain and vehicle type. Lines in the charts below are smoothed using loess smoothihng. The "Data" tab shows the raw data, which also includes the 25th and 75th quantiles. See the [about](about.html#depreciation) page for more details. Note the [observation counts](about.html#listing-counts) by powertrain and vehicle type as some combinations have few observations.

```{r}
#| include: false

source("setup.R")

# Convert age from months to years
data <- depreciation |>
  mutate(age_years = age_bin / 12)

# Helper function to apply loess smoothing to a group
smooth_group <- function(df, x_col, y_col, span = 0.5) {
  if (nrow(df) < 10) {
    df$rr_smooth <- df[[y_col]]
    return(df)
  }
  tryCatch({
    fit <- suppressWarnings(loess(df[[y_col]] ~ df[[x_col]], span = span))
    df$rr_smooth <- predict(fit)
    df
  }, error = function(e) {
    df$rr_smooth <- df[[y_col]]
    df
  })
}

# Apply smoothing to all data
data <- data |>
  group_by(powertrain, vehicle_type, quantile) |>
  group_modify(~ smooth_group(.x, "age_years", "rr")) |>
  ungroup()

# Filter to 50th quantile for charts
chart_data <- data |>
  filter(quantile == 50)

# Helper function to create a chart for a given facet
make_chart <- function(data, facet_var, facet_value, line_var) {
  plot_data <- data |>
    filter(.data[[facet_var]] == facet_value)

  plot_data |>
    group_by(.data[[line_var]]) |>
    e_charts(age_years) |>
    e_line(rr_smooth, symbol = "none", smooth = FALSE) |>
    e_tooltip(
      trigger = "axis",
      formatter = htmlwidgets::JS("
        function(params) {
          var result = params[0].axisValueLabel + '<br/>';
          params.forEach(function(item) {
            result += item.marker + ' ' + item.seriesName + ': ' +
                      item.value[1].toFixed(2) + '<br/>';
          });
          return result;
        }
      ")
    ) |>
    e_x_axis(name = "Age (years)") |>
    e_y_axis(name = "Retention Rate") |>
    e_legend(
      show = TRUE,
      orient = "horizontal",
      left = "center",
      bottom = 0,
      width = "70%",
      selector = list(
        list(type = "all", title = "All"),
        list(type = "inverse", title = "Inverse")
      ),
      selectorPosition = "start"
    ) |>
    e_grid(bottom = 100) |>
    e_color(background = "transparent") |>
    e_toolbox_feature(feature = "dataZoom") |>
    e_toolbox_feature(feature = "saveAsImage")
}
```

## By Vehicle Type

*Click legend items to show/hide lines.*

::: {.grid}

::: {.g-col-6}

### Car
```{r}
make_chart(chart_data, "vehicle_type", "Car", "powertrain")
```

:::

::: {.g-col-6}

### CUV
```{r}
make_chart(chart_data, "vehicle_type", "CUV", "powertrain")
```

:::

::: {.g-col-6}

### SUV
```{r}
make_chart(chart_data, "vehicle_type", "SUV", "powertrain")
```

:::

::: {.g-col-6}

### Pickup
```{r}
make_chart(chart_data, "vehicle_type", "Pickup", "powertrain")
```

:::

::: {.g-col-6}

### Minivan
```{r}
make_chart(chart_data, "vehicle_type", "Minivan", "powertrain")
```

:::

:::

## By Powertrain

*Click legend items to show/hide lines.*

::: {.grid}

::: {.g-col-6}

### Gasoline
```{r}
make_chart(chart_data, "powertrain", "Gasoline", "vehicle_type")
```

:::

::: {.g-col-6}

### Flex Fuel (E85)
```{r}
make_chart(chart_data, "powertrain", "Flex Fuel (E85)", "vehicle_type")
```

:::

::: {.g-col-6}

### Hybrid Electric (HEV)
```{r}
make_chart(chart_data, "powertrain", "Hybrid Electric (HEV)", "vehicle_type")
```

:::

::: {.g-col-6}

### Plug-In Hybrid Electric (PHEV)
```{r}
make_chart(chart_data, "powertrain", "Plug-In Hybrid Electric (PHEV)", "vehicle_type")
```

:::

::: {.g-col-6}

### Battery Electric (BEV)
```{r}
make_chart(chart_data, "powertrain", "Battery Electric (BEV)", "vehicle_type")
```

:::

::: {.g-col-6}

### BEV (Tesla)
```{r}
make_chart(chart_data, "powertrain", "BEV (Tesla)", "vehicle_type")
```

:::

::: {.g-col-6}

### BEV (Non-Tesla)
```{r}
make_chart(chart_data, "powertrain", "BEV (Non-Tesla)", "vehicle_type")
```

:::

::: {.g-col-6}

### Fuel Cell
```{r}
make_chart(chart_data, "powertrain", "Fuel Cell", "vehicle_type")
```

:::

:::

## Data: Depreciation by Age

<center>
[Download data](`r url_depreciation`)

<div style="width:900px">

```{r}
data |>
  mutate(
    age_years = round(age_years, 2),
    rr = round(rr, 3),
    rr_smooth = round(rr_smooth, 3)
  ) |>
  select(powertrain, vehicle_type, age_years, quantile, rr, rr_smooth) |>
  rename(
    Powertrain = powertrain,
    `Vehicle Type` = vehicle_type,
    `Age (years)` = age_years,
    Quantile = quantile,
    `Retention Rate` = rr,
    `Retention Rate (Smoothed)` = rr_smooth
  ) |>
  reactable::reactable(
    searchable = TRUE,
    highlight = TRUE,
    filterable = TRUE,
    defaultPageSize = 10,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 10, 25, 50)
  )
```

</div>
</center>

## Data: Annual Depreciation by Type

This table shows the estimated annual depreciation rate by vehicle type and powertrain. Annual depreciation is computed by fitting log-linear regressions of retention rate on vehicle age; the rate is `1 - exp(b)` where `b` is the age coefficient.

<center>
[Download data](`r url_dep_annual_type`)

<div style="width:700px">

```{r}
dep_annual_type |>
  mutate(dep_annual = round(dep_annual, 4)) |>
  rename(
    `Vehicle Type` = vehicle_type,
    Powertrain = powertrain,
    `Annual Depreciation Rate` = dep_annual
  ) |>
  reactable::reactable(
    searchable = TRUE,
    highlight = TRUE,
    filterable = TRUE,
    defaultPageSize = 10,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 10, 25, 50)
  )
```

</div>
</center>

## Data: Annual Depreciation by Model

This table shows the estimated annual depreciation rate by make, model, vehicle type, and powertrain. Annual depreciation is computed by fitting log-linear regressions of retention rate on vehicle age; the rate is `1 - exp(b)` where `b` is the age coefficient. Only make/model combinations with at least 100 listings are included.

<center>
[Download data](`r url_dep_annual_model`)

<div style="width:900px">

```{r}
dep_annual_model |>
  mutate(dep_annual = round(dep_annual, 4)) |>
  rename(
    Make = make,
    Model = model,
    `Vehicle Type` = vehicle_type,
    Powertrain = powertrain,
    `Annual Depreciation Rate` = dep_annual
  ) |>
  reactable::reactable(
    searchable = TRUE,
    highlight = TRUE,
    filterable = TRUE,
    defaultPageSize = 10,
    showPageSizeOptions = TRUE,
    pageSizeOptions = c(5, 10, 25, 50)
  )
```

</div>
</center>
